#!/usr/bin/env python3

import argparse
import os
import sys

CHUNK_SIZE = 34  # 32 bytes of data + 2 bytes of CRC16
DATA_SIZE = 32   # Number of bytes to keep

def uncrc(input_path, output_path):
    with open(input_path, "rb") as infile, open(output_path, "wb") as outfile:
        while True:
            chunk = infile.read(CHUNK_SIZE)
            if not chunk:
                break
            if len(chunk) < CHUNK_SIZE:
                print("Warning: last block is smaller than 34 bytes â€” skipping.")
                break
            outfile.write(chunk[:DATA_SIZE])

    output_size = os.path.getsize(output_path)
    print(f"Output written to: {output_path} ({(output_size / 1024):.2f} KB)")

def main():
    parser = argparse.ArgumentParser(description="Unencrypt file with CRC16 blocks of 32 bytes")
    parser.add_argument("input", help="Path to input file")
    parser.add_argument("output", nargs="?", help="Path to output file")
    args = parser.parse_args()

    input_path = args.input

    if not os.path.isfile(input_path):
        print(f"Error: Input file '{input_path}' does not exist.", file=sys.stderr)
        sys.exit(1)

    if args.output:
        output_path = args.output
    else:
        if input_path.endswith("_crc.bin"):
            output_path = input_path.replace("_crc.bin", ".bin")
        else:
            print("Error: Output file not specified and input filename doesn't end with '_crc.bin'.", file=sys.stderr)
            sys.exit(1)

    uncrc(input_path, output_path)

if __name__ == "__main__":
    main()
